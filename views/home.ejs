<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />
</head>

<style>
  /* Hide scrollbar for all browsers */
  .scrollbar-none {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE and Edge */
  }

  .scrollbar-none::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }

  .rotate-180 {
    transform: rotate(180deg);
  }
</style>

<body>
  <div class="p-4 py-4 dark:bg-gray-900 bg-blue-200 flex flex-col h-screen w-screen overflow-hidden">

    <div class="flex justify-between mb-4 items-center">
      <h1 class="text-white font-bold">Welcome <span class="text-yellow-300 uppercase text-xl"><%=user%></span></h1>
      <form action="/logout" method="post"><button class="logOut bg-red-500 px-2 py-2 rounded-xl text-white font-semibold hover:bg-red-800">Logout</button>
      </form></div>

    <button id="upload" onclick="show()"
      class="justify-center sm:h-16 w-auto font-semibold text-2xl p-4 rounded-xl text-white hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-50 transition duration-300 ease-in-out dark:bg-blue-800">
      Upload Files
    </button>

    <form action="/upload" method="post" enctype="multipart/form-data">

      <div id="hello" class="hidden flex-col items-center justify-center h-screen">
        <div class="absolute top-16 right-6">
          <i onclick="hide()" class="ri-close-circle-line text-4xl hover:opacity-50 dark:text-white"></i>
        </div>
        <div class="flex w-104 items-center justify-center">
          <label for="dropzone-file"
            class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-blue-300 dark:hover:bg-gray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <svg class="w-8 h-8 mb-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" />
              </svg>
              <p class="mb-2 text-sm text-gray-500 dark:text-gray-400">
                <span class="font-semibold">Click to upload</span> or drag and
                drop
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                SVG, PNG, JPG or GIF (MAX. 800x400px)
              </p>
            </div>
            <input id="dropzone-file" type="file" class="hidden" name="file" />
          </label>
        </div>
        <button type="submit"
          class="mt-10 text-white h-auto w-auto bg-gray-600 hover:bg-gray-800 p-4 py-2 text-xl font-semibold rounded-xl">
          Upload
        </button>
      </div>
    </form>

    <div id="files" class="mt-8 files flex flex-col gap-2 overflow-y-auto h-full scrollbar-none">
      <% files.forEach((file) => { %>
        <div class="bg-gray-400 rounded-lg p-4 flex flex-col gap-2">
          <!-- Top bar -->
          <div class="flex justify-between items-center">
            <h1 class="text-black font-semibold"><%= file.originalName %></h1>
            <div class="flex items-center gap-2">
              <button onclick="copyLink('<%= file.signedUrl %>')" 
                class="bg-gray-900 px-4 py-2 font-semibold text-white rounded-md hover:bg-gray-600">
          <i class="ri-link"></i>
        </button>
        
                    <form action="/delete/<%= file._id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete this file?');">
                <button type="submit" class="bg-red-500 px-4 py-2 font-semibold text-white rounded-md hover:bg-red-700">
                  <i class="ri-delete-bin-fill"></i>
                </button>
              </form>
              <a href="#" onclick="downloadFile('<%= file.signedUrl %>', '<%= file.originalName %>')"
                class="cursor-pointer bg-blue-800 px-4 py-2 rounded-lg text-white font-semibold hover:bg-blue-600">
                <i class="ri-download-2-fill"></i>
              </a>
              <a href="<%= file.signedUrl %>" target="_blank"
                class="cursor-pointer bg-green-600 px-4 py-2 rounded-lg text-white font-semibold hover:bg-green-800">
                <i class="ri-eye-fill"></i>
             </a>
              <i class="ri-arrow-drop-down-fill text-3xl cursor-pointer transition-transform duration-300"
                 onclick="toggleDetails('<%= file._id %>', this)"></i>
            </div>
          </div>
    
          <!-- Hidden collapsible file details -->
          <div id="details-<%= file._id %>" class="hidden transition-all ease-in-out overflow-hidden">
            <div class="mt-2 p-4 bg-blue-100 rounded-md text-sm text-black">
              <p><strong>Uploaded:</strong> <%= file.uploadedAt?.toLocaleString() || "N/A" %></p>
              <p><strong>Type:</strong> <%= file.mimetype || "Unknown" %></p>
              <p><strong>Size:</strong> <%= (file.size / 1024).toFixed(2) %> KB</p>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
    

  </div>

  
  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>

</html>

<script>
  function show() {
    document.querySelector("#upload").style.display = "none";
    document.querySelector("#files").style.display = "none";
    document.querySelector("#hello").style.display = "flex";
  }

  function hide() {
    document.querySelector("#upload").style.display = "flex";
    document.querySelector("#hello").style.display = "none";
    document.querySelector("#files").style.display = "flex";
  }
  async function downloadFile(url, filename) {
    try {
      const response = await fetch(url);
      const blob = await response.blob();

      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } catch (err) {
      alert("Download failed!");
      console.error(err);
    }
  }

function toggleDetails(id, icon) {
  const details = document.getElementById(`details-${id}`);
  if (details.classList.contains('hidden')) {
    details.classList.remove('hidden');
    icon.classList.add('-rotate-90'); // optional: rotate icon
  } else {
    details.classList.add('hidden');
    icon.classList.remove('-rotate-90');
  }
}
function copyLink(url) {
    navigator.clipboard.writeText(url)
      .then(() => alert("Public link copied to clipboard!"))
      .catch((err) => {
        console.error("Failed to copy link:", err);
        alert("Failed to copy link.");
      });
  }

</script>